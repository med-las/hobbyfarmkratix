FROM golang:1.24-alpine AS builder

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o provisioner cmd/main.go

FROM ubuntu:20.04

# Install required tools
RUN apt-get update && apt-get install -y \
    ansible \
    openssh-client \
    python3 \
    python3-pip \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Copy binary
COPY --from=builder /app/provisioner /app/provisioner

# Copy ansible playbooks
COPY ansible/ /app/ansible/

# Create necessary directories
RUN mkdir -p /root/.ssh /etc/provisioner

# Set proper permissions
RUN chmod 700 /root/.ssh

EXPOSE 8443

ENTRYPOINT ["/app/provisioner"]
